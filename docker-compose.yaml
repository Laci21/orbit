version: '3.8'

services:
  # SLIM Server (based on lungo pattern)
  slim:
    image: ghcr.io/agntcy/slim:0.3.15
    container_name: slim
    ports:
      - "46357:46357"
    environment:
      - PASSWORD=${SLIM_GATEWAY_PASSWORD:-dummy_password}
      - CONFIG_PATH=/config.yaml
    volumes:
      - ./config/docker/slim/server-config.yaml:/config.yaml
    command: ["/slim", "--config", "/config.yaml"]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:46357/health"]
      interval: 10s
      timeout: 5s
      retries: 3
    restart: unless-stopped

  # AGNTCY Infrastructure Services - SLIM removed (using direct A2A communication)
  # slim:
  #   image: ghcr.io/agntcy/slim:0.3.15
  #   container_name: slim
  #   ports:
  #     - "46357:46357"
  #   environment:
  #     - PASSWORD=${SLIM_GATEWAY_PASSWORD:-dummy_password}
  #     - CONFIG_PATH=/config.yaml
  #   volumes:
  #     - ./config/docker/slim/server-config.yaml:/config.yaml
  #   command: ["/slim", "--config", "/config.yaml"]
  #   healthcheck:
  #     test: ["CMD", "curl", "-f", "http://localhost:46357/health"]
  #     interval: 10s
  #     timeout: 5s
  #     retries: 3

  # Orbit Agent Services
  ear-to-ground:
    build:
      context: .
      dockerfile: docker/Dockerfile.ear-to-ground
    platform: linux/amd64
    ports:
      - "9001:9001"    # HTTP (UI)
    environment:
      - AZURE_OPENAI_API_KEY=${AZURE_OPENAI_API_KEY}
      - AZURE_OPENAI_DEPLOYMENT_NAME=${AZURE_OPENAI_DEPLOYMENT_NAME}
      - AZURE_OPENAI_API_VERSION=${AZURE_OPENAI_API_VERSION}
      - AZURE_OPENAI_ENDPOINT=${AZURE_OPENAI_ENDPOINT}
      - ORBIT_TWEET_FILE=/app/data/tweets_astronomer.json
      - AGENT_PORT=9001
      - SLIM_ENDPOINT=slim://slim:46357
      - SENTIMENT_ANALYST_URL=slim://sentiment-analyst
      - FACT_CHECKER_URL=slim://fact-checker
      - RISK_SCORE_URL=slim://risk-score
      - PRESS_SECRETARY_URL=slim://press-secretary
    volumes:
      - ./data:/app/data:ro
      - ./:/app:cached
    restart: unless-stopped
    command: >
      sh -c "watchfiles --filter python 'python -m agents.ear_to_ground.server' /app"

  sentiment-analyst:
    build:
      context: .
      dockerfile: docker/Dockerfile.sentiment-analyst
    platform: linux/amd64
    ports:
      - "9002:9002"    # HTTP (UI)
    environment:
      - AZURE_OPENAI_API_KEY=${AZURE_OPENAI_API_KEY}
      - AZURE_OPENAI_DEPLOYMENT_NAME=${AZURE_OPENAI_DEPLOYMENT_NAME}
      - AZURE_OPENAI_API_VERSION=${AZURE_OPENAI_API_VERSION}
      - AZURE_OPENAI_ENDPOINT=${AZURE_OPENAI_ENDPOINT}
      - AGENT_PORT=9002
      - SLIM_ENDPOINT=slim://slim:46357
    volumes:
      - ./:/app:cached
    restart: unless-stopped
    command: >
      sh -c "watchfiles --filter python 'python -m agents.sentiment_analyst.server' /app"

  risk-score:
    build:
      context: .
      dockerfile: docker/Dockerfile.risk-score
    platform: linux/amd64
    ports:
      - "9003:9003"    # HTTP (UI)
    environment:
      - AZURE_OPENAI_API_KEY=${AZURE_OPENAI_API_KEY}
      - AZURE_OPENAI_DEPLOYMENT_NAME=${AZURE_OPENAI_DEPLOYMENT_NAME}
      - AZURE_OPENAI_API_VERSION=${AZURE_OPENAI_API_VERSION}
      - AZURE_OPENAI_ENDPOINT=${AZURE_OPENAI_ENDPOINT}
      - CRISIS_THRESHOLD=${CRISIS_THRESHOLD:-7.0}
      - AGENT_PORT=9003
      - SLIM_ENDPOINT=slim://slim:46357
      - PRESS_SECRETARY_URL=slim://press-secretary
    volumes:
      - ./:/app:cached
    restart: unless-stopped
    command: >
      sh -c "watchfiles --filter python 'python -m agents.risk_score.server' /app"

  fact-checker:
    build:
      context: .
      dockerfile: docker/Dockerfile.fact-checker
    platform: linux/amd64
    ports:
      - "9004:9004"    # HTTP (UI)
    environment:
      - AZURE_OPENAI_API_KEY=${AZURE_OPENAI_API_KEY}
      - AZURE_OPENAI_DEPLOYMENT_NAME=${AZURE_OPENAI_DEPLOYMENT_NAME}
      - AZURE_OPENAI_API_VERSION=${AZURE_OPENAI_API_VERSION}
      - AZURE_OPENAI_ENDPOINT=${AZURE_OPENAI_ENDPOINT}
      - AGENT_PORT=9004
      - SLIM_ENDPOINT=slim://slim:46357
      - LEGAL_COUNSEL_URL=slim://legal-counsel
      - RISK_SCORE_URL=slim://risk-score
    volumes:
      - ./data:/app/data:ro
      - ./:/app:cached
    restart: unless-stopped
    command: >
      sh -c "watchfiles --filter python 'python -m agents.fact_checker.server' /app"

  legal-counsel:
    build:
      context: .
      dockerfile: docker/Dockerfile.legal-counsel
    platform: linux/amd64
    ports:
      - "9005:9005"    # HTTP (UI)
    environment:
      - AZURE_OPENAI_API_KEY=${AZURE_OPENAI_API_KEY}
      - AZURE_OPENAI_DEPLOYMENT_NAME=${AZURE_OPENAI_DEPLOYMENT_NAME}
      - AZURE_OPENAI_API_VERSION=${AZURE_OPENAI_API_VERSION}
      - AZURE_OPENAI_ENDPOINT=${AZURE_OPENAI_ENDPOINT}
      - AGENT_PORT=9005
      - SLIM_ENDPOINT=slim://slim:46357
      - LEGAL_RUBRIC_PATH=data/legal_rubric.md
    volumes:
      - ./data:/app/data:ro
      - ./:/app:cached
    restart: unless-stopped
    command: >
      sh -c "watchfiles --filter python 'python -m agents.legal_counsel.server' /app"

  press-secretary:
    build:
      context: .
      dockerfile: docker/Dockerfile.press-secretary
    platform: linux/amd64
    ports:
      - "9006:9006"    # HTTP (UI)
    environment:
      - AZURE_OPENAI_API_KEY=${AZURE_OPENAI_API_KEY}
      - AZURE_OPENAI_DEPLOYMENT_NAME=${AZURE_OPENAI_DEPLOYMENT_NAME}
      - AZURE_OPENAI_API_VERSION=${AZURE_OPENAI_API_VERSION}
      - AZURE_OPENAI_ENDPOINT=${AZURE_OPENAI_ENDPOINT}
      - AGENT_PORT=9006
      - SLIM_ENDPOINT=slim://slim:46357
    volumes:
      - ./:/app:cached
    restart: unless-stopped
    command: >
      sh -c "watchfiles --filter python 'python -m agents.press_secretary.server' /app"


  # Gateway Service (FastAPI + React UI)
  gateway:
    build:
      context: .
      dockerfile: docker/Dockerfile.gateway
    platform: linux/amd64
    ports:
      - "8000:8000"  # FastAPI + React UI  
      - "5173:5173"  # Vite dev server
    environment:
      - GATEWAY_PORT=8000
      - EAR_TO_GROUND_URL=http://ear-to-ground:9001
    volumes:
      - ./:/app:cached  # Enable hot reload for gateway code
    depends_on:
      - slim
      - ear-to-ground
      - sentiment-analyst
      - risk-score
      - fact-checker
      - legal-counsel
      - press-secretary
    restart: unless-stopped
    command: >
      sh -c "watchfiles --filter python 'python -m gateway.main' /app"

networks:
  default:
    name: orbit-network